from telegram import ReplyKeyboardMarkup, Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from flask import Flask
import threading

TOKEN = '7600734297:AAEUfHpSLgxMyRj8vxC8rto3upyB9hVC2ys'  # –í—Å—Ç–∞–≤—å —Ç–æ–∫–µ–Ω –æ—Ç BotFather

# –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
questions = [
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–±–∏—Ä–∞—Ç—å –∏–≥—Ä—É—à–∫–∏. –í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è?",
        "a": [
            "1. \"–°–µ–π—á–∞—Å –∂–µ —É–±–µ—Ä–∏, –∏–Ω–∞—á–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ!\"",
            "2. \"–î–∞–≤–∞–π —É–±–µ—Ä–µ–º –≤–º–µ—Å—Ç–µ, –∞ –ø–æ—Ç–æ–º –ø–æ—á–∏—Ç–∞–µ–º –∫–Ω–∏–∂–∫—É\"",
            "3. \"–õ–∞–¥–Ω–æ, —è —Å–∞–º–∞ —É–±–µ—Ä—É\"",
            "4. –ù–µ –æ–±—Ä–∞—â–∞—é –≤–Ω–∏–º–∞–Ω–∏—è"
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –ø–æ–ª—É—á–∏–ª –¥–≤–æ–π–∫—É. –í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è?",
        "a": [
            "1. \"–¢—ã –±–µ—Å—Ç–æ–ª–∫–æ–≤—ã–π! –ù–∏–∫–∞–∫–∏—Ö –≥—É–ª—è–Ω–∏–π!\"",
            "2. \"–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º –æ—à–∏–±–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–∏–º\"",
            "3. \"–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ, –±—ã–≤–∞–µ—Ç\"",
            "4. \"–¢–≤–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –ø—Ä–æ—Å–∏—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É—à–∫—É –≤ –º–∞–≥–∞–∑–∏–Ω–µ. –í—ã:",
        "a": [
            "1. \"–ù–µ—Ç, –∏ –≤—Å–µ!\"",
            "2. \"–î–∞–≤–∞–π –∑–∞–ø–∏—à–µ–º –≤ —Å–ø–∏—Å–æ–∫ –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è\"",
            "3. \"–õ–∞–¥–Ω–æ, –±–µ—Ä–∏, —Ç–æ–ª—å–∫–æ –Ω–µ –ø–ª–∞—á—å\"",
            "4. \"–û—Ç—Å—Ç–∞–Ω—å, –º–Ω–µ –Ω–µ–∫–æ–≥–¥–∞\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç \"–Ø —Å–∞–º!\", –Ω–æ —É –Ω–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è. –í—ã:",
        "a": [
            "1. \"–î–∞–π —è —Å–¥–µ–ª–∞—é, —É —Ç–µ–±—è –Ω–µ –≤—ã–π–¥–µ—Ç!\"",
            "2. \"–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑, —è –ø–æ–º–æ–≥—É –µ—Å–ª–∏ –Ω–∞–¥–æ\"",
            "3. \"–î–µ–ª–∞–π –∫–∞–∫ –∑–Ω–∞–µ—à—å\"",
            "4. –ù–µ –æ–±—Ä–∞—â–∞—é –≤–Ω–∏–º–∞–Ω–∏—è"
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –ø–ª–∞—á–µ—Ç –∏–∑-–∑–∞ —Å—Å–æ—Ä—ã —Å –¥—Ä—É–≥–æ–º. –í—ã:",
        "a": [
            "1. \"–•–≤–∞—Ç–∏—Ç —Ä–µ–≤–µ—Ç—å! –°–∞–º–∞ –≤–∏–Ω–æ–≤–∞—Ç–∞!\"",
            "2. \"–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å. –î–∞–≤–∞–π –ø—Ä–∏–¥—É–º–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ\"",
            "3. \"–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, –∫—É–ø–∏–º –º–æ—Ä–æ–∂–µ–Ω–æ–µ\"",
            "4. \"–†–∞–∑–±–∏—Ä–∞–π—Å—è —Å–∞–º–∞\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –Ω–µ —Ö–æ—á–µ—Ç –ª–æ–∂–∏—Ç—å—Å—è —Å–ø–∞—Ç—å. –í—ã:",
        "a": [
            "1. \"–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤ –∫—Ä–æ–≤–∞—Ç—å!\"",
            "2. \"–î–∞–≤–∞–π –≤—ã–±–µ—Ä–µ–º: —Å–µ–π—á–∞—Å –∏–ª–∏ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç?\"",
            "3. \"–õ–æ–∂–∏—Å—å –∫–æ–≥–¥–∞ —Ö–æ—á–µ—à—å\"",
            "4. \"–ú–Ω–µ –≤—Å–µ —Ä–∞–≤–Ω–æ\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –≥–æ–≤–æ—Ä–∏—Ç \"–Ø —Ç–µ–±—è –Ω–µ–Ω–∞–≤–∏–∂—É!\". –í–∞—à–∞ —Ä–µ–∞–∫—Ü–∏—è:",
        "a": [
            "1. \"–ö–∞–∫ —Ç—ã —Å–º–µ–µ—à—å! –ù–∞–∫–∞–∑–∞–Ω!\"",
            "2. \"–Ø –≤–∏–∂—É, —Ç—ã –∑–ª–∏—à—å—Å—è. –î–∞–≤–∞–π –æ–±–Ω–∏–º–µ–º—Å—è?\"",
            "3. \"–ù—É –∏ –ª–∞–¥–Ω–æ\"",
            "4. –ò–≥–Ω–æ—Ä–∏—Ä—É—é"
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ —Ö–æ—á–µ—Ç –Ω–∞–¥–µ—Ç—å –≤ —Å–∞–¥ –Ω–µ–ª–µ–ø—ã–π –Ω–∞—Ä—è–¥. –í—ã:",
        "a": [
            "1. \"–ù–∞–¥–µ–Ω–µ—à—å —Ç–æ, —á—Ç–æ —è —Å–∫–∞–∑–∞–ª–∞!\"",
            "2. \"–î–∞–≤–∞–π –≤—ã–±–µ—Ä–µ–º —á—Ç–æ-—Ç–æ –≤–º–µ—Å—Ç–µ\"",
            "3. \"–ù—É —Ö–æ—Ä–æ—à–æ, –∏–¥–∏ —Ç–∞–∫\"",
            "4. \"–ú–Ω–µ –≤—Å–µ —Ä–∞–≤–Ω–æ\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ —Ä–∞–∑–±–∏–ª –≤–∞–∑—É. –í—ã:",
        "a": [
            "1. \"–†—É–∫–∏-–∫—Ä—é–∫–∏! –í–µ—á–Ω–æ —É —Ç–µ–±—è –≤—Å–µ –ø–∞–¥–∞–µ—Ç!\"",
            "2. \"–î–∞–≤–∞–π —É–±–µ—Ä–µ–º –æ—Å–∫–æ–ª–∫–∏ –≤–º–µ—Å—Ç–µ. –ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ\"",
            "3. \"–ù–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ\"",
            "4. \"–°–∞–º —Ä–∞–∑–±–∏—Ä–∞–π—Å—è\""
        ]
    },
    {
        "q": "–†–µ–±–µ–Ω–æ–∫ –ø—Ä–æ—Å–∏—Ç –≤–∞—à–µ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è, –∞ –≤—ã —É—Å—Ç–∞–ª–∏. –í—ã:",
        "a": [
            "1. \"–ù–µ –º–µ—à–∞–π!\"",
            "2. \"–î–∞–≤–∞–π —è –æ—Ç–¥–æ—Ö–Ω—É 15 –º–∏–Ω—É—Ç, –∞ –ø–æ—Ç–æ–º –ø–æ–∏–≥—Ä–∞–µ–º\"",
            "3. \"–í–æ—Ç —Ç–µ–±–µ –ø–ª–∞–Ω—à–µ—Ç\"",
            "4. \"–û—Ç—Å—Ç–∞–Ω—å\""
        ]
    }
]

# –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ (–±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å —Å—Ç–∏–ª–∏)
answer_map = {
    "1": "–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω—ã–π",
    "2": "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π",
    "3": "–õ–∏–±–µ—Ä–∞–ª—å–Ω—ã–π",
    "4": "–ò–Ω–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–π"
}

user_data = {}

def start(update: Update, context: CallbackContext):
    name = update.message.from_user.first_name
    update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {name}!\n"
        "–•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å, –∫–∞–∫–æ–π —É –≤–∞—Å —Å—Ç–∏–ª—å –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è –∏ –∫–∞–∫ –æ–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–±–µ–Ω–∫–∞?\n\n"
        "–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç (10 –≤–æ–ø—Ä–æ—Å–æ–≤) ‚Üí /start_test"
    )

def start_test(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    user_data[user_id] = {
        "current_q": 0,
        "answers": []
    }
    send_question(update, context)

def send_question(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    data = user_data[user_id]
    q_num = data["current_q"]
    if q_num < len(questions):
        q_data = questions[q_num]
        keyboard = [[a] for a in q_data["a"]]
        reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)
        update.message.reply_text(f"–í–æ–ø—Ä–æ—Å {q_num + 1}:\n{q_data['q']}", reply_markup=reply_markup)
    else:
        show_result(update, context)

def handle_answer(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    text = update.message.text
    data = user_data.get(user_id)
    if not data:
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Å /start_test")
        return

    # –û–ø—Ä–µ–¥–µ–ª–∏–º –Ω–æ–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    for i in range(4):
        if text.startswith(str(i + 1)):
            data["answers"].append(str(i + 1))
            break
    else:
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")
        return

    data["current_q"] += 1
    send_question(update, context)

def show_result(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    answers = user_data[user_id]["answers"]
    style_count = {"–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω—ã–π": 0, "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π": 0, "–õ–∏–±–µ—Ä–∞–ª—å–Ω—ã–π": 0, "–ò–Ω–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–π": 0}
    for a in answers:
        style_count[answer_map[a]] += 1
    style = max(style_count, key=style_count.get)

    result_texts = {
        "–ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω—ã–π": "–í—ã - —Å—Ç—Ä–æ–≥–∏–π —Ä–æ–¥–∏—Ç–µ–ª—å. –ü—Ä–∞–≤–∏–ª–∞ –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –¥–ª—è –≤–∞—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –º–µ—Å—Ç–µ.\n\n..."
                        "\n–°–æ–≤–µ—Ç:\n1. –û–±—ä—è—Å–Ω–∏—Ç—å –æ–¥–Ω–æ –ø—Ä–∞–≤–∏–ª–æ –≤–º–µ—Å—Ç–æ –ø—Ä–∏–∫–∞–∑–∞\n2. –°–ø—Ä–æ—Å–∏—Ç—å –º–Ω–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞ –≤ –º–µ–ª–æ—á–∞—Ö",
        "–ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π": "–í—ã –Ω–∞—à–ª–∏ –∑–æ–ª–æ—Ç—É—é —Å–µ—Ä–µ–¥–∏–Ω—É! –°–æ—á–µ—Ç–∞–µ—Ç–µ –ª—é–±–æ–≤—å –∏ —Ä–∞–∑—É–º–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã.\n\n..."
                        "\n–°–æ–≤–µ—Ç:\n1. –î–∞–≤–∞–π—Ç–µ –±–æ–ª—å—à–µ –≤—ã–±–æ—Ä–∞\n2. –•–≤–∞–ª–∏—Ç–µ –∑–∞ —É—Å–∏–ª–∏—è, –∞ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–õ–∏–±–µ—Ä–∞–ª—å–Ω—ã–π": "–í—ã - –¥—Ä—É–≥ —Å–≤–æ–µ–º—É —Ä–µ–±–µ–Ω–∫—É. –ò–∑–±–µ–≥–∞–µ—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.\n\n..."
                        "\n–°–æ–≤–µ—Ç:\n1. –í–≤–µ–¥–∏—Ç–µ 2-3 –ø—Ä–∞–≤–∏–ª–∞\n2. –ì–æ–≤–æ—Ä–∏—Ç–µ '–Ω–µ—Ç' —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º",
        "–ò–Ω–¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ç–Ω—ã–π": "–í—ã —Ä–µ–¥–∫–æ –≤–º–µ—à–∏–≤–∞–µ—Ç–µ—Å—å –≤ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏–µ.\n\n..."
                        "\n–°–æ–≤–µ—Ç:\n1. 10 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –Ω–∞ –æ–±—â–µ–Ω–∏–µ\n2. –°–ø—Ä–∞—à–∏–≤–∞–π—Ç–µ –æ –µ–≥–æ –¥–µ–ª–∞—Ö"
    }

    update.message.reply_text(
        f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {style}\n\n{result_texts[style]}\n\n"
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞!\n\n"
        "üëâ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª ‚Üí @ParentStyleBot\n"
        "üîÅ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –µ—â–µ —Ä–∞–∑ ‚Üí /start_test"
    )
    user_data.pop(user_id)


app = Flask(__name__)

@app.route('/ping')
def ping():
    return 'pong', 200

def run_flask():
    app.run(host='0.0.0.0', port=8080)


def main():
    threading.Thread(target=run_flask).start()
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("start_test", start_test))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_answer))
    updater.start_polling()
    print("Bot started. Listening...")
    updater.idle()

if __name__ == '__main__':
    main()


